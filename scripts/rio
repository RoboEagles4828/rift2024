#!/usr/bin/bash

IP_ADDRESS="10.48.28.2"

check-directory() {
    if [ ! -f "$1/robot.py" ]; then
        echo "ERROR: $1/robot.py does not exist!"
        exit
    fi
}

sshCommand() {
    ssh -t lvuser@$IP_ADDRESS "$@"
}

restart-code() {
    sshCommand "/usr/local/frc/bin/frcKillRobot.sh"
}

sync() {
    check-directory $1
    # Instead of copying all files, it should read the .riosyncmetadata file instead to determine what files changed 
    RSYNC_RESULT=$(rsync -azPi \
        --exclude __pycache__ \
        --exclude .pathplanner \
        --exclude simgui*.json \
        $1 lvuser@$IP_ADDRESS:/home/lvuser/py/)
    
    if [ -n "${RSYNC_RESULT}" ]; then
        echo "Result: $RSYNC_RESULT"
        restart-code
    else
        echo "No changes made: $RSYNC_RESULT"
    fi

}

install-fastdeploy() {
    # Untested currently, but should work if the RIO has internet
    # Do note: the RIO NEEDS INTERNET for this to work
    sshCommand "opkg update"
    sshCommand "opkg install rsync"
}

help() {
    echo "In active development!"
    echo "Here be dragons!"
}

case $1 in 
    "check")
        check-directory "${2-.}"
    ;;

    "restart")
        restart-code
    ;;

    "deploy")
        echo "Would deploy here..."
    ;;

    "sync")
        sync "${2-.}"
    ;;

    "ssh")
        sshCommand
    ;;

    "install-fastdeploy")
        install-fastdeploy
    ;;

    "help")
        help
    ;;
    
    *)
        echo "Unknown option: \"$1\""
        help
    ;;
esac